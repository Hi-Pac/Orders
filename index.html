<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة طلبات عبوات البلاستيك</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.2/css/buttons.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.2/js/dataTables.buttons.min.js"></script>
    
    <!-- PDF & Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.print.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#6c757d',
                        success: '#198754',
                        danger: '#dc3545',
                        warning: '#ffc107',
                        info: '#0dcaf0',
                        light: '#f8f9fa',
                        dark: '#212529',
                    }
                }
            }
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
        }
        
        /* Dark Mode Styles */
        .dark {
            color-scheme: dark;
        }
        
        .dark body {
            background-color: #181818;
            color: #e2e2e2;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #ordersTable, #ordersTable * {
                visibility: visible;
            }
            
            #ordersTable {
                position: absolute;
                top: 0;
                right: 0;
                width: 100%;
            }
            
            .no-print, .actions-column, .status-actions, .dataTables_filter, 
            .dataTables_length, .dataTables_paginate, .dataTables_info {
                display: none !important;
            }
            
            html, body {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
            }
            
            @page {
                size: landscape;
            }
        }
        
        /* Custom DataTables styling */
        .dataTables_wrapper .dataTables_filter input,
        .dataTables_wrapper .dataTables_length select {
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        
        .dark .dataTables_wrapper .dataTables_filter input,
        .dark .dataTables_wrapper .dataTables_length select {
            background-color: #333;
            color: #e2e2e2;
            border-color: #555;
        }
        
        table.dataTable thead th, 
        table.dataTable thead td {
            padding: 10px 18px;
            border-bottom: 1px solid #ddd;
        }
        
        .dark table.dataTable thead th, 
        .dark table.dataTable thead td {
            border-bottom: 1px solid #444;
        }
        
        .dark .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #e2e2e2 !important;
        }
        
        .dark table.dataTable tbody tr {
            background-color: #222;
        }
        
        /* Status styles */
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-accepted {
            background-color: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-delivered {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-overdue {
            background-color: #ffe6e6;
            color: #993333;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .dark .status-pending {
            background-color: #3a3000;
            color: #ffdb7d;
        }
        
        .dark .status-accepted {
            background-color: #0a3622;
            color: #75e0a7;
        }
        
        .dark .status-rejected {
            background-color: #380e14;
            color: #f5a8b0;
        }
        
        .dark .status-delivered {
            background-color: #0c3c47;
            color: #8dddec;
        }
        
        .dark .status-overdue {
            background-color: #3d1414;
            color: #ffb3b3;
        }
        
        /* Inactivity timer */
        .inactivity-warning {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }
        
        .dark .inactivity-warning {
            background-color: #380e14;
            color: #f5a8b0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="dark:bg-gray-900 dark:text-white">
    <div id="inactivityWarning" class="inactivity-warning">
        <p>سيتم تسجيل الخروج تلقائيًا بعد <span id="logoutCountdown">60</span> ثانية من عدم النشاط</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                    تسجيل الدخول
                </h2>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="rounded-md -space-y-px">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">البريد الإلكتروني</label>
                        <input id="email" name="email" type="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 text-base">
                    </div>
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">كلمة المرور</label>
                        <input id="password" name="password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 text-base">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <button type="button" id="registerBtn" class="group relative w-1/2 flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        تسجيل حساب جديد
                    </button>
                    <button type="submit" class="group relative w-1/2 flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        تسجيل الدخول
                    </button>
                </div>
                <div id="loginError" class="mt-3 text-center text-red-600 dark:text-red-400 text-sm hidden"></div>
            </form>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-800 dark:opacity-80"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button type="button" id="closeRegisterModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <span class="sr-only">إغلاق</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:text-right">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                        تسجيل حساب جديد
                    </h3>
                    <form id="registerForm" class="mt-4">
                        <div class="mb-4">
                            <label for="regName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">الاسم</label>
                            <input type="text" id="regName" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div class="mb-4">
                            <label for="regEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">البريد الإلكتروني</label>
                            <input type="email" id="regEmail" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div class="mb-4">
                            <label for="regPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">كلمة المرور</label>
                            <input type="password" id="regPassword" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div class="mb-4">
                            <label for="regConfirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">تأكيد كلمة المرور</label>
                            <input type="password" id="regConfirmPassword" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div id="regError" class="mt-2 text-red-600 dark:text-red-400 text-sm hidden"></div>
                        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mr-3 sm:w-auto sm:text-sm">
                                تسجيل
                            </button>
                            <button type="button" id="cancelRegister" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">نظام إدارة طلبات عبوات البلاستيك</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="userName" class="text-gray-700 dark:text-gray-300 ml-4"></span>
                    <button id="logoutBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Order Form -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
                <h2 class="text-xl font-bold mb-6 text-gray-900 dark:text-white">طلب تصنيع عبوات بلاستيك</h2>
                <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Customer Name -->
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">اسم العميل</label>
                        <input type="text" id="customerName" name="customerName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                    </div>

                    <!-- Size -->
                    <div>
                        <label for="size" class="block text-sm font-medium text-gray-700 dark:text-gray-300">المقاس</label>
                        <select id="size" name="size" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                            <option value="" disabled selected>اختر المقاس</option>
                            <option value="بستلة 21">بستلة 21</option>
                            <option value="بستلة 19">بستلة 19</option>
                            <option value="بستلة 17.2">بستلة 17.2</option>
                            <option value="بستلة 17">بستلة 17</option>
                            <option value="بستلة 16">بستلة 16</option>
                            <option value="بستلة 14">بستلة 14</option>
                            <option value="بستلة 13">بستلة 13</option>
                            <option value="بستلة 12">بستلة 12</option>
                            <option value="بستلة 11">بستلة 11</option>
                            <option value="بستلة 11.2">بستلة 11.2</option>
                            <option value="بستلة 10">بستلة 10</option>
                            <option value="بستلة 9">بستلة 9</option>
                            <option value="بستلة 6">بستلة 6</option>
                            <option value="بستلة 6.2">بستلة 6.2</option>
                            <option value="بستلة 6.1">بستلة 6.1</option>
                            <option value="بستلة 3.8">بستلة 3.8</option>
                            <option value="بستلة 3.9">بستلة 3.9</option>
                            <option value="بستلة 3.7">بستلة 3.7</option>
                            <option value="بستلة 3">بستلة 3</option>
                            <option value="بستلة 3.1">بستلة 3.1</option>
                            <option value="بستلة 2.6">بستلة 2.6</option>
                            <option value="عبوة 1.3">عبوة 1.3</option>
                            <option value="عبوة 1.25">عبوة 1.25</option>
                            <option value="عبوة كيلو">عبوة كيلو</option>
                            <option value="عبوة 1 لتر">عبوة 1 لتر</option>
                            <option value="عبوة 0.9 لتر">عبوة 0.9 لتر</option>
                            <option value="عبوة 500 مللى">عبوة 500 مللى</option>
                        </select>
                    </div>

                    <!-- Color -->
                    <div>
                        <label for="color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">اللون</label>
                        <select id="color" name="color" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                            <option value="" disabled selected>اختر اللون</option>
                            <option value="ابيض">ابيض</option>
                            <option value="شفاف">شفاف</option>
                            <option value="هابى باك">هابى باك</option>
                            <option value="سادة">سادة</option>
                            <option value="مطبوع">مطبوع</option>
                            <option value="هابى">هابى</option>
                        </select>
                    </div>

                    <!-- Print Type -->
                    <div>
                        <label for="printType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">الطباعة</label>
                        <select id="printType" name="printType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                            <option value="" disabled selected>اختر نوع الطباعة</option>
                            <option value="سادة">سادة</option>
                            <option value="حرارى">حرارى</option>
                            <option value="سيلك سكرين">سيلك سكرين</option>
                        </select>
                    </div>

                    <!-- Handle -->
                    <div>
                        <label for="handle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">بيد/بدون يد</label>
                        <select id="handle" name="handle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                            <option value="" disabled selected>اختر النوع</option>
                            <option value="بيد">بيد</option>
                            <option value="بدون يد">بدون يد</option>
                        </select>
                    </div>

                    <!-- Quantity -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">العدد المطلوب</label>
                        <input type="number" id="quantity" name="quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                    </div>

                    <!-- Delivery Date -->
                    <div>
                        <label for="deliveryDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">تاريخ التسليم</label>
                        <input type="date" id="deliveryDate" name="deliveryDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                    </div>

                    <!-- Payment Terms -->
                    <div class="md:col-span-2 lg:col-span-3">
                        <label for="paymentTerms" class="block text-sm font-medium text-gray-700 dark:text-gray-300">شروط الدفع</label>
                        <textarea id="paymentTerms" name="paymentTerms" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base"></textarea>
                    </div>

                    <div class="md:col-span-2 lg:col-span-3 flex flex-wrap justify-end gap-3 mt-4">
                        <button type="button" id="resetFormBtn" class="py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            إعادة تعيين الحقول
                        </button>
                        <button type="submit" id="submitOrderBtn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            إرسال الطلب
                        </button>
                    </div>
                </form>
            </div>

            <!-- Orders Table -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <div class="flex flex-wrap justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">قائمة الطلبات</h2>
                    
                    <div class="flex flex-wrap gap-4 mt-4 sm:mt-0">
                        <div class="w-full sm:w-auto">
                            <label for="statusFilter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تصفية حسب الحالة</label>
                            <select id="statusFilter" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                                <option value="all">إلغاء التصفية</option>
                                <option value="pending">الطلبات المعلقة</option>
                                <option value="accepted">الطلبات المقبولة</option>
                                <option value="rejected">الطلبات المرفوضة</option>
                                <option value="delivered">طلبات تم تسليمها</option>
                                <option value="overdue">طلبات لم تسلم (تخطت الموعد)</option>
                                <option value="today">طلبات تسليم اليوم</option>
                            </select>
                        </div>
                        
                        <div class="w-full sm:w-auto">
                            <label for="daysFilter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تصفية حسب الأيام المتبقية</label>
                            <input type="number" id="daysFilter" min="0" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="ordersTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">اسم العميل</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">المقاس</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">اللون</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الطباعة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">بيد/بدون يد</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">العدد المطلوب</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">شروط الدفع</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ التسليم</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الأيام المتبقية</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">حالة الطلب</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-column">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                
                <div class="mt-6 flex flex-wrap gap-3 justify-start">
                    <button id="printTableBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 no-print">
                        <i class="fas fa-print mr-2"></i> طباعة الجدول
                    </button>
                    <button id="exportPdfBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 no-print">
                        <i class="fas fa-file-pdf mr-2"></i> تصدير PDF
                    </button>
                    <button id="exportExcelBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 no-print">
                        <i class="fas fa-file-excel mr-2"></i> تصدير Excel
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-800 dark:opacity-80"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button type="button" id="closeOrderDetailsModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <span class="sr-only">إغلاق</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:text-right">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                        تفاصيل الطلب
                    </h3>
                    <div id="orderDetailsContent" class="mt-4 text-right"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-800 dark:opacity-80"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button type="button" id="closeEditOrderModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <span class="sr-only">إغلاق</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:text-right">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                        تعديل الطلب
                    </h3>
                    <form id="editOrderForm" class="mt-4">
                        <input type="hidden" id="editOrderId">
                        <div class="mb-4">
                            <label for="editCustomerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">اسم العميل</label>
                            <input type="text" id="editCustomerName" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div class="mb-4">
                            <label for="editSize" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">المقاس</label>
                            <select id="editSize" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                                <option value="بستلة 21">بستلة 21</option>
                                <option value="بستلة 19">بستلة 19</option>
                                <option value="بستلة 17.2">بستلة 17.2</option>
                                <option value="بستلة 17">بستلة 17</option>
                                <option value="بستلة 16">بستلة 16</option>
                                <option value="بستلة 14">بستلة 14</option>
                                <option value="بستلة 13">بستلة 13</option>
                                <option value="بستلة 12">بستلة 12</option>
                                <option value="بستلة 11">بستلة 11</option>
                                <option value="بستلة 11.2">بستلة 11.2</option>
                                <option value="بستلة 10">بستلة 10</option>
                                <option value="بستلة 9">بستلة 9</option>
                                <option value="بستلة 6">بستلة 6</option>
                                <option value="بستلة 6.2">بستلة 6.2</option>
                                <option value="بستلة 6.1">بستلة 6.1</option>
                                <option value="بستلة 3.8">بستلة 3.8</option>
                                <option value="بستلة 3.9">بستلة 3.9</option>
                                <option value="بستلة 3.7">بستلة 3.7</option>
                                <option value="بستلة 3">بستلة 3</option>
                                <option value="بستلة 3.1">بستلة 3.1</option>
                                <option value="بستلة 2.6">بستلة 2.6</option>
                                <option value="عبوة 1.3">عبوة 1.3</option>
                                <option value="عبوة 1.25">عبوة 1.25</option>
                                <option value="عبوة كيلو">عبوة كيلو</option>
                                <option value="عبوة 1 لتر">عبوة 1 لتر</option>
                                <option value="عبوة 0.9 لتر">عبوة 0.9 لتر</option>
                                <option value="عبوة 500 مللى">عبوة 500 مللى</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="editColor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">اللون</label>
                            <select id="editColor" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                                <option value="ابيض">ابيض</option>
                                <option value="شفاف">شفاف</option>
                                <option value="هابى باك">هابى باك</option>
                                <option value="سادة">سادة</option>
                                <option value="مطبوع">مطبوع</option>
                                <option value="هابى">هابى</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="editPrintType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">الطباعة</label>
                            <select id="editPrintType" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                                <option value="سادة">سادة</option>
                                <option value="حرارى">حرارى</option>
                                <option value="سيلك سكرين">سيلك سكرين</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="editHandle" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">بيد/بدون يد</label>
                            <select id="editHandle" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                                <option value="بيد">بيد</option>
                                <option value="بدون يد">بدون يد</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="editQuantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">العدد المطلوب</label>
                            <input type="number" id="editQuantity" min="1" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div class="mb-4">
                            <label for="editDeliveryDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">تاريخ التسليم</label>
                            <input type="date" id="editDeliveryDate" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3">
                        </div>
                        <div class="mb-4">
                            <label for="editPaymentTerms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">شروط الدفع</label>
                            <textarea id="editPaymentTerms" rows="3" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3"></textarea>
                        </div>
                        <div id="editError" class="mt-2 text-red-600 dark:text-red-400 text-sm hidden"></div>
                        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mr-3 sm:w-auto sm:text-sm">
                                حفظ التعديلات
                            </button>
                            <button type="button" id="cancelEdit" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div id="rejectReasonModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-800 dark:opacity-80"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button type="button" id="closeRejectReasonModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <span class="sr-only">إغلاق</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:text-right">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                        سبب رفض الطلب
                    </h3>
                    <form id="rejectReasonForm" class="mt-4">
                        <input type="hidden" id="rejectOrderId">
                        <div class="mb-4">
                            <label for="rejectReason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right">سبب الرفض</label>
                            <textarea id="rejectReason" rows="3" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-base py-2 px-3" required></textarea>
                        </div>
                        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:mr-3 sm:w-auto sm:text-sm">
                                تأكيد الرفض
                            </button>
                            <button type="button" id="cancelReject" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-800 dark:opacity-80"></div>
            </div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="mt-3 text-center sm:mt-0 sm:text-right">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                        تأكيد الحذف
                    </h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        هل أنت متأكد من رغبتك في حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.
                    </p>
                    <input type="hidden" id="deleteOrderId">
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" id="confirmDelete" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:mr-3 sm:w-auto sm:text-sm">
                            حذف
                        </button>
                        <button type="button" id="cancelDelete" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-primary mb-4"></div>
            <p class="text-gray-700 dark:text-gray-300">جار التحميل...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8loT0jeGJFUxPsLzbD-ItHU2UbBxCCSU",
            authDomain: "plastic-app-3d2af.firebaseapp.com",
            projectId: "plastic-app-3d2af",
            storageBucket: "plastic-app-3d2af.firebasestorage.app",
            messagingSenderId: "847266877084",
            appId: "1:847266877084:web:7b1881d1d8c6744bd82759",
            measurementId: "G-0108S3D9ML"
        };

        // Telegram Configuration
        const TELEGRAM_TOKEN = "8132622542:AAF0nG25doWftQA1-RThLKKEb_HeAATVbOA";
        const CHAT_ID = "-4618423800";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global Variables
        let currentUser = null;
        let userRole = "user"; // Default role is user
        let ordersTable = null;
        let inactivityTimer = null;
        let logoutCountdown = null;
        let logoutCountdownInterval = null;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const registerBtn = document.getElementById('registerBtn');
        const registerModal = document.getElementById('registerModal');
        const registerForm = document.getElementById('registerForm');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const cancelRegister = document.getElementById('cancelRegister');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const orderForm = document.getElementById('orderForm');
        const resetFormBtn = document.getElementById('resetFormBtn');
        const inactivityWarning = document.getElementById('inactivityWarning');
        const logoutCountdownEl = document.getElementById('logoutCountdown');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Order Details Modal Elements
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeOrderDetailsModal = document.getElementById('closeOrderDetailsModal');
        const orderDetailsContent = document.getElementById('orderDetailsContent');
        
        // Edit Order Modal Elements
        const editOrderModal = document.getElementById('editOrderModal');
        const closeEditOrderModal = document.getElementById('closeEditOrderModal');
        const cancelEdit = document.getElementById('cancelEdit');
        const editOrderForm = document.getElementById('editOrderForm');
        
        // Reject Reason Modal Elements
        const rejectReasonModal = document.getElementById('rejectReasonModal');
        const closeRejectReasonModal = document.getElementById('closeRejectReasonModal');
        const cancelReject = document.getElementById('cancelReject');
        const rejectReasonForm = document.getElementById('rejectReasonForm');
        
        // Confirm Delete Modal Elements
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        
        // Table Filter Elements
        const statusFilter = document.getElementById('statusFilter');
        const daysFilter = document.getElementById('daysFilter');
        
        // Print and Export Buttons
        const printTableBtn = document.getElementById('printTableBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userRole = userDoc.data().role || 'user';
                        userName.textContent = userDoc.data().name || user.email;
                    } else {
                        // Create user document if it doesn't exist
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            name: user.displayName || '',
                            role: 'user',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        userRole = 'user';
                        userName.textContent = user.displayName || user.email;
                    }
                    
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    
                    initializeOrdersTable();
                    resetInactivityTimer();
                } else {
                    currentUser = null;
                    mainApp.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }
            });
            
            // Login form submission
            loginForm.addEventListener('submit', handleLogin);
            
            // Register button click
            registerBtn.addEventListener('click', () => {
                registerModal.classList.remove('hidden');
            });
            
            // Close register modal
            closeRegisterModal.addEventListener('click', () => {
                registerModal.classList.add('hidden');
            });
            
            // Cancel register
            cancelRegister.addEventListener('click', () => {
                registerModal.classList.add('hidden');
            });
            
            // Register form submission
            registerForm.addEventListener('submit', handleRegister);
            
            // Logout button click
            logoutBtn.addEventListener('click', () => {
                auth.signOut();
                clearInactivityTimer();
            });
            
            // Order form submission
            orderForm.addEventListener('submit', handleOrderSubmit);
            
            // Reset form button click
            resetFormBtn.addEventListener('click', () => {
                orderForm.reset();
            });
            
            // Close order details modal
            closeOrderDetailsModal.addEventListener('click', () => {
                orderDetailsModal.classList.add('hidden');
            });
            
            // Close edit order modal
            closeEditOrderModal.addEventListener('click', () => {
                editOrderModal.classList.add('hidden');
            });
            
            // Cancel edit order
            cancelEdit.addEventListener('click', () => {
                editOrderModal.classList.add('hidden');
            });
            
            // Edit order form submission
            editOrderForm.addEventListener('submit', handleEditOrderSubmit);
            
            // Close reject reason modal
            closeRejectReasonModal.addEventListener('click', () => {
                rejectReasonModal.classList.add('hidden');
            });
            
            // Cancel reject order
            cancelReject.addEventListener('click', () => {
                rejectReasonModal.classList.add('hidden');
            });
            
            // Reject reason form submission
            rejectReasonForm.addEventListener('submit', handleRejectOrder);
            
            // Cancel delete order
            cancelDelete.addEventListener('click', () => {
                confirmDeleteModal.classList.add('hidden');
            });
            
            // Confirm delete order
            confirmDelete.addEventListener('click', handleDeleteOrder);
            
            // Status filter change
            statusFilter.addEventListener('change', () => {
                if (ordersTable) {
                    ordersTable.draw();
                }
                // Reset days filter when status filter changes
                daysFilter.value = '';
            });
            
            // Days filter change
            daysFilter.addEventListener('input', () => {
                if (ordersTable) {
                    ordersTable.draw();
                }
                // Reset status filter when days filter changes
                statusFilter.value = 'all';
            });
            
            // Print table button click
            printTableBtn.addEventListener('click', () => {
                window.print();
            });
            
            // Export PDF button click
            exportPdfBtn.addEventListener('click', exportToPdf);
            
            // Export Excel button click
            exportExcelBtn.addEventListener('click', exportToExcel);
            
            // Setup inactivity detection
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keydown', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            document.addEventListener('touchstart', resetInactivityTimer);
        });
        
        // Handle Login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            try {
                showLoading();
                await auth.signInWithEmailAndPassword(email, password);
                loginError.classList.add('hidden');
                hideLoading();
            } catch (error) {
                hideLoading();
                loginError.textContent = getAuthErrorMessage(error);
                loginError.classList.remove('hidden');
            }
        }
        
        // Handle Register
        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const regError = document.getElementById('regError');
            
            if (password !== confirmPassword) {
                regError.textContent = 'كلمة المرور غير متطابقة';
                regError.classList.remove('hidden');
                return;
            }
            
            try {
                showLoading();
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    role: 'user', // Default role is user
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update user profile
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                registerModal.classList.add('hidden');
                regError.classList.add('hidden');
                hideLoading();
            } catch (error) {
                hideLoading();
                regError.textContent = getAuthErrorMessage(error);
                regError.classList.remove('hidden');
            }
        }
        
        // Handle Order Submit
        async function handleOrderSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                // Redirect to login
                auth.signOut();
                return;
            }
            
            const formData = {
                customerName: document.getElementById('customerName').value,
                size: document.getElementById('size').value,
                color: document.getElementById('color').value,
                printType: document.getElementById('printType').value,
                handle: document.getElementById('handle').value,
                quantity: parseInt(document.getElementById('quantity').value),
                deliveryDate: document.getElementById('deliveryDate').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: userName.textContent || currentUser.email
                }
            };
            
            try {
                showLoading();
                
                // Add order to Firestore
                const docRef = await db.collection('orders').add(formData);
                
                // Send Telegram notification
                await sendTelegramNotification('new_order', {
                    ...formData,
                    id: docRef.id
                });
                
                // Reset form
                orderForm.reset();
                
                // Refresh table
                ordersTable.ajax.reload();
                
                hideLoading();
                
                // Show success message
                alert('تم إرسال الطلب بنجاح');
            } catch (error) {
                hideLoading();
                console.error('Error submitting order:', error);
                alert('حدث خطأ أثناء إرسال الطلب. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Handle Edit Order Submit
        async function handleEditOrderSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                // Redirect to login
                auth.signOut();
                return;
            }
            
            const orderId = document.getElementById('editOrderId').value;
            
            const formData = {
                customerName: document.getElementById('editCustomerName').value,
                size: document.getElementById('editSize').value,
                color: document.getElementById('editColor').value,
                printType: document.getElementById('editPrintType').value,
                handle: document.getElementById('editHandle').value,
                quantity: parseInt(document.getElementById('editQuantity').value),
                deliveryDate: document.getElementById('editDeliveryDate').value,
                paymentTerms: document.getElementById('editPaymentTerms').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: userName.textContent || currentUser.email
                }
            };
            
            try {
                showLoading();
                
                // Update order in Firestore
                await db.collection('orders').doc(orderId).update(formData);
                
                // Close modal
                editOrderModal.classList.add('hidden');
                
                // Refresh table
                ordersTable.ajax.reload();
                
                hideLoading();
                
                // Show success message
                alert('تم تحديث الطلب بنجاح');
            } catch (error) {
                hideLoading();
                console.error('Error updating order:', error);
                alert('حدث خطأ أثناء تحديث الطلب. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Handle Reject Order
        async function handleRejectOrder(e) {
            e.preventDefault();
            
            if (!currentUser) {
                // Redirect to login
                auth.signOut();
                return;
            }
            
            const orderId = document.getElementById('rejectOrderId').value;
            const rejectReason = document.getElementById('rejectReason').value;
            
            try {
                showLoading();
                
                // Get order data
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    throw new Error('Order not found');
                }
                
                const orderData = orderDoc.data();
                
                // Update order in Firestore
                await db.collection('orders').doc(orderId).update({
                    status: 'rejected',
                    rejectReason: rejectReason,
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: userName.textContent || currentUser.email
                    }
                });
                
                // Send Telegram notification
                await sendTelegramNotification('reject_order', {
                    ...orderData,
                    id: orderId,
                    rejectReason: rejectReason
                });
                
                // Close modal
                rejectReasonModal.classList.add('hidden');
                
                // Refresh table
                ordersTable.ajax.reload();
                
                hideLoading();
                
                // Show success message
                alert('تم رفض الطلب بنجاح');
            } catch (error) {
                hideLoading();
                console.error('Error rejecting order:', error);
                alert('حدث خطأ أثناء رفض الطلب. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Handle Accept Order
        async function handleAcceptOrder(orderId) {
            if (!currentUser) {
                // Redirect to login
                auth.signOut();
                return;
            }
            
            try {
                showLoading();
                
                // Get order data
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    throw new Error('Order not found');
                }
                
                const orderData = orderDoc.data();
                
                // Update order in Firestore
                await db.collection('orders').doc(orderId).update({
                    status: 'accepted',
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    acceptedBy: {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: userName.textContent || currentUser.email
                    }
                });
                
                // Send Telegram notification
                await sendTelegramNotification('accept_order', {
                    ...orderData,
                    id: orderId
                });
                
                // Refresh table
                ordersTable.ajax.reload();
                
                hideLoading();
                
                // Show success message
                alert('تم قبول الطلب بنجاح');
            } catch (error) {
                hideLoading();
                console.error('Error accepting order:', error);
                alert('حدث خطأ أثناء قبول الطلب. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Handle Delete Order
        async function handleDeleteOrder() {
            if (!currentUser) {
                // Redirect to login
                auth.signOut();
                return;
            }
            
            const orderId = document.getElementById('deleteOrderId').value;
            
            try {
                showLoading();
                
                // Delete order from Firestore
                await db.collection('orders').doc(orderId).delete();
                
                // Close modal
                confirmDeleteModal.classList.add('hidden');
                
                // Refresh table
                ordersTable.ajax.reload();
                
                hideLoading();
                
                // Show success message
                alert('تم حذف الطلب بنجاح');
            } catch (error) {
                hideLoading();
                console.error('Error deleting order:', error);
                alert('حدث خطأ أثناء حذف الطلب. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Handle Mark as Delivered
        async function handleMarkAsDelivered(orderId) {
            if (!currentUser) {
                // Redirect to login
                auth.signOut();
                return;
            }
            
            try {
                showLoading();
                
                // Update order in Firestore
                await db.collection('orders').doc(orderId).update({
                    status: 'delivered',
                    deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deliveredBy: {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: userName.textContent || currentUser.email
                    }
                });
                
                // Refresh table
                ordersTable.ajax.reload();
                
                hideLoading();
                
                // Show success message
                alert('تم تحديث حالة الطلب إلى "تم التسليم" بنجاح');
            } catch (error) {
                hideLoading();
                console.error('Error marking order as delivered:', error);
                alert('حدث خطأ أثناء تحديث حالة الطلب. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Initialize Orders Table
        function initializeOrdersTable() {
            // Custom filtering function for DataTables
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    // Skip filtering if no status filter is selected or if it's set to 'all'
                    if (statusFilter.value === 'all' && daysFilter.value === '') {
                        return true;
                    }
                    
                    // Status filtering
                    if (statusFilter.value !== 'all' && daysFilter.value === '') {
                        const status = data[9]; // Status column
                        
                        if (statusFilter.value === 'pending' && !status.includes('معلق')) {
                            return false;
                        }
                        if (statusFilter.value === 'accepted' && !status.includes('مقبول')) {
                            return false;
                        }
                        if (statusFilter.value === 'rejected' && !status.includes('مرفوض')) {
                            return false;
                        }
                        if (statusFilter.value === 'delivered' && !status.includes('تم التسليم')) {
                            return false;
                        }
                        if (statusFilter.value === 'overdue' && !status.includes('تخطى موعد التسليم')) {
                            return false;
                        }
                        if (statusFilter.value === 'today') {
                            const today = new Date().toISOString().split('T')[0];
                            const deliveryDate = data[7].split('/').reverse().join('-'); // Convert dd/mm/yyyy to yyyy-mm-dd
                            return deliveryDate === today;
                        }
                    }
                    
                    // Days remaining filtering
                    if (daysFilter.value !== '' && statusFilter.value === 'all') {
                        const daysRemaining = parseInt(data[8]); // Days remaining column
                        const filterDays = parseInt(daysFilter.value);
                        
                        return daysRemaining === filterDays;
                    }
                    
                    return true;
                }
            );
            
            // Initialize DataTables
            ordersTable = $('#ordersTable').DataTable({
                ajax: {
                    url: '#',
                    type: 'GET',
                    dataType: 'json',
                    dataSrc: function() {
                        return getOrdersData();
                    }
                },
                columns: [
                    { data: 'customerName' },
                    { data: 'size' },
                    { data: 'color' },
                    { data: 'printType' },
                    { data: 'handle' },
                    { data: 'quantity' },
                    { data: 'paymentTerms' },
                    { 
                        data: 'deliveryDate',
                        render: function(data) {
                            // Convert yyyy-mm-dd to dd/mm/yyyy
                            const dateParts = data.split('-');
                            return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                        }
                    },
                    { data: 'daysRemaining' },
                    { 
                        data: 'status',
                        render: function(data, type, row) {
                            let statusClass = '';
                            let statusText = '';
                            
                            switch(data) {
                                case 'pending':
                                    statusClass = 'status-pending';
                                    statusText = 'معلق';
                                    break;
                                case 'accepted':
                                    statusClass = 'status-accepted';
                                    statusText = 'مقبول';
                                    break;
                                case 'rejected':
                                    statusClass = 'status-rejected';
                                    statusText = 'مرفوض';
                                    break;
                                case 'delivered':
                                    statusClass = 'status-delivered';
                                    statusText = 'تم التسليم';
                                    break;
                                case 'overdue':
                                    statusClass = 'status-overdue';
                                    statusText = 'تخطى موعد التسليم';
                                    break;
                                default:
                                    statusClass = 'status-pending';
                                    statusText = 'معلق';
                            }
                            
                            return `<span class="${statusClass}">${statusText}</span>`;
                        }
                    },
                    { 
                        data: 'id',
                        className: 'actions-column',
                        render: function(data, type, row) {
                            let actions = `
                                <div class="flex flex-wrap gap-2 justify-center status-actions">
                                    <button onclick="showOrderDetails('${data}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                        <i class="fas fa-eye"></i>
                                    </button>
                            `;
                            
                            // Add edit button for admin
                            if (userRole === 'admin') {
                                actions += `
                                    <button onclick="showEditOrderModal('${data}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                `;
                            }
                            
                            // Add delete button for admin
                            if (userRole === 'admin') {
                                actions += `
                                    <button onclick="showDeleteConfirmation('${data}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                `;
                            }
                            
                            // Add approve/reject buttons for admin and approver
                            if ((userRole === 'admin' || userRole === 'approver') && row.status === 'pending') {
                                actions += `
                                    <button onclick="handleAcceptOrder('${data}')" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button onclick="showRejectReasonModal('${data}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                            }
                            
                            // Add delivered checkbox for admin and approver
                            if ((userRole === 'admin' || userRole === 'approver') && 
                                (row.status === 'accepted' || row.status === 'overdue')) {
                                actions += `
                                    <div class="flex items-center">
                                        <input type="checkbox" id="delivered-${data}" 
                                            class="form-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:border-gray-600"
                                            onchange="handleMarkAsDelivered('${data}')"
                                            ${row.status === 'delivered' ? 'checked' : ''}>
                                        <label for="delivered-${data}" class="mr-2 block text-sm text-gray-900 dark:text-gray-300">تم التسليم</label>
                                    </div>
                                `;
                            }
                            
                            actions += `</div>`;
                            
                            return actions;
                        }
                    }
                ],
                columnDefs: [
                    { targets: [5, 8], className: 'text-center' },
                    { targets: [6], className: 'truncate max-w-xs' },
                    { targets: [9, 10], className: 'text-center' }
                ],
                order: [[8, 'asc']],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.1/i18n/ar.json'
                },
                responsive: true,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'pdfHtml5',
                        text: 'تصدير PDF',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
                        },
                        orientation: 'landscape',
                        customize: function(doc) {
                            doc.defaultStyle.direction = 'rtl';
                            doc.defaultStyle.font = 'Tajawal';
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        text: 'تصدير Excel',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
                        }
                    },
                    {
                        extend: 'print',
                        text: 'طباعة',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
                        },
                        customize: function(win) {
                            $(win.document.body).addClass('rtl');
                        }
                    }
                ]
            });
            
            // Hide buttons since we have custom buttons
            $('.dt-buttons').hide();
        }
        
        // Get Orders Data
        async function getOrdersData() {
            if (!currentUser) {
                return [];
            }
            
            try {
                const ordersSnapshot = await db.collection('orders').get();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const orders = [];
                
                ordersSnapshot.forEach(doc => {
                    const data = doc.data();
                    const deliveryDate = new Date(data.deliveryDate);
                    deliveryDate.setHours(0, 0, 0, 0);
                    
                    // Calculate days remaining
                    const diffTime = deliveryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    // Determine status
                    let status = data.status || 'pending';
                    
                    // If delivered, keep status as delivered
                    if (status === 'delivered') {
                        // Keep as is
                    }
                    // If delivery date has passed and not delivered, mark as overdue
                    else if (diffDays < 0 && status !== 'delivered') {
                        status = 'overdue';
                    }
                    
                    orders.push({
                        id: doc.id,
                        customerName: data.customerName || '',
                        size: data.size || '',
                        color: data.color || '',
                        printType: data.printType || '',
                        handle: data.handle || '',
                        quantity: data.quantity || 0,
                        paymentTerms: data.paymentTerms || '',
                        deliveryDate: data.deliveryDate || '',
                        daysRemaining: diffDays,
                        status: status,
                        createdBy: data.createdBy || {},
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        rejectReason: data.rejectReason || ''
                    });
                });
                
                return orders;
            } catch (error) {
                console.error('Error fetching orders:', error);
                return [];
            }
        }
        
        // Show Order Details
        window.showOrderDetails = async function(orderId) {
            try {
                showLoading();
                
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    throw new Error('Order not found');
                }
                
                const data = orderDoc.data();
                const deliveryDate = new Date(data.deliveryDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                deliveryDate.setHours(0, 0, 0, 0);
                
                // Calculate days remaining
                const diffTime = deliveryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Format dates
                const createdAtDate = data.createdAt ? data.createdAt.toDate() : new Date();
                const formattedCreatedAt = `${createdAtDate.getDate()}/${createdAtDate.getMonth() + 1}/${createdAtDate.getFullYear()} ${createdAtDate.getHours()}:${createdAtDate.getMinutes().toString().padStart(2, '0')}`;
                
                // Format delivery date
                const formattedDeliveryDate = `${deliveryDate.getDate()}/${deliveryDate.getMonth() + 1}/${deliveryDate.getFullYear()}`;
                
                let statusText = '';
                let statusClass = '';
                
                // Determine status
                let status = data.status || 'pending';
                
                // If delivered, keep status as delivered
                if (status === 'delivered') {
                    statusText = 'تم التسليم';
                    statusClass = 'status-delivered';
                }
                // If delivery date has passed and not delivered, mark as overdue
                else if (diffDays < 0 && status !== 'delivered') {
                    statusText = 'تخطى موعد التسليم';
                    statusClass = 'status-overdue';
                }
                else if (status === 'pending') {
                    statusText = 'معلق';
                    statusClass = 'status-pending';
                }
                else if (status === 'accepted') {
                    statusText = 'مقبول';
                    statusClass = 'status-accepted';
                }
                else if (status === 'rejected') {
                    statusText = 'مرفوض';
                    statusClass = 'status-rejected';
                }
                
                let detailsHTML = `
                    <div class="grid grid-cols-1 gap-4">
                        <div class="border-b dark:border-gray-700 pb-2">
                            <h4 class="font-bold text-gray-700 dark:text-gray-300">بيانات الطلب</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">اسم العميل:</p>
                                    <p class="font-medium">${data.customerName || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">المقاس:</p>
                                    <p class="font-medium">${data.size || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">اللون:</p>
                                    <p class="font-medium">${data.color || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">الطباعة:</p>
                                    <p class="font-medium">${data.printType || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">بيد/بدون يد:</p>
                                    <p class="font-medium">${data.handle || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">العدد المطلوب:</p>
                                    <p class="font-medium">${data.quantity || '0'}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">شروط الدفع:</p>
                                    <p class="font-medium">${data.paymentTerms || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">تاريخ التسليم:</p>
                                    <p class="font-medium">${formattedDeliveryDate}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">الأيام المتبقية:</p>
                                    <p class="font-medium">${diffDays}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">حالة الطلب:</p>
                                    <p class="font-medium"><span class="${statusClass}">${statusText}</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-b dark:border-gray-700 pb-2">
                            <h4 class="font-bold text-gray-700 dark:text-gray-300">بيانات المستخدم</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">اسم المستخدم:</p>
                                    <p class="font-medium">${data.createdBy?.name || data.createdBy?.email || ''}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">البريد الإلكتروني:</p>
                                    <p class="font-medium">${data.createdBy?.email || ''}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">تاريخ ووقت التسجيل:</p>
                                    <p class="font-medium">${formattedCreatedAt}</p>
                                </div>
                            </div>
                        </div>
                `;
                
                // If rejected, show reject reason
                if (status === 'rejected' && data.rejectReason) {
                    detailsHTML += `
                        <div>
                            <h4 class="font-bold text-gray-700 dark:text-gray-300">سبب الرفض</h4>
                            <p class="mt-1">${data.rejectReason}</p>
                        </div>
                    `;
                }
                
                detailsHTML += `</div>`;
                
                orderDetailsContent.innerHTML = detailsHTML;
                orderDetailsModal.classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error fetching order details:', error);
                alert('حدث خطأ أثناء عرض تفاصيل الطلب. يرجى المحاولة مرة أخرى.');
            }
        };
        
        // Show Edit Order Modal
        window.showEditOrderModal = async function(orderId) {
            try {
                showLoading();
                
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    throw new Error('Order not found');
                }
                
                const data = orderDoc.data();
                
                document.getElementById('editOrderId').value = orderId;
                document.getElementById('editCustomerName').value = data.customerName || '';
                document.getElementById('editSize').value = data.size || '';
                document.getElementById('editColor').value = data.color || '';
                document.getElementById('editPrintType').value = data.printType || '';
                document.getElementById('editHandle').value = data.handle || '';
                document.getElementById('editQuantity').value = data.quantity || '';
                document.getElementById('editDeliveryDate').value = data.deliveryDate || '';
                document.getElementById('editPaymentTerms').value = data.paymentTerms || '';
                
                editOrderModal.classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error loading order for edit:', error);
                alert('حدث خطأ أثناء تحميل بيانات الطلب. يرجى المحاولة مرة أخرى.');
            }
        };
        
        // Show Reject Reason Modal
        window.showRejectReasonModal = function(orderId) {
            document.getElementById('rejectOrderId').value = orderId;
            document.getElementById('rejectReason').value = '';
            rejectReasonModal.classList.remove('hidden');
        };
        
        // Show Delete Confirmation
        window.showDeleteConfirmation = function(orderId) {
            document.getElementById('deleteOrderId').value = orderId;
            confirmDeleteModal.classList.remove('hidden');
        };
        
        // Send Telegram Notification
        async function sendTelegramNotification(type, data) {
            try {
                const today = new Date();
                const formattedToday = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
                
                let message = '';
                
                if (type === 'new_order') {
                    message = `🆕 *طلب جديد*\n\n`;
                    message += `*بيانات الطلب:*\n`;
                    message += `- اسم العميل: ${data.customerName}\n`;
                    message += `- المقاس: ${data.size}\n`;
                    message += `- اللون: ${data.color}\n`;
                    message += `- الطباعة: ${data.printType}\n`;
                    message += `- بيد/بدون يد: ${data.handle}\n`;
                    message += `- العدد المطلوب: ${data.quantity}\n`;
                    message += `- شروط الدفع: ${data.paymentTerms}\n`;
                    
                    // Format delivery date
                    const deliveryDate = new Date(data.deliveryDate);
                    const formattedDeliveryDate = `${deliveryDate.getDate()}/${deliveryDate.getMonth() + 1}/${deliveryDate.getFullYear()}`;
                    message += `- تاريخ التسليم: ${formattedDeliveryDate}\n`;
                    
                    // Calculate days remaining
                    const diffTime = deliveryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    message += `- الأيام المتبقية: ${diffDays}\n\n`;
                    
                    message += `*بيانات المستخدم:*\n`;
                    message += `- اسم المستخدم: ${data.createdBy.name || data.createdBy.email}\n`;
                    message += `- البريد الإلكتروني: ${data.createdBy.email}\n`;
                    message += `- تاريخ التسجيل: ${formattedToday}\n`;
                }
                else if (type === 'accept_order') {
                    message = `✅ *تمت الموافقة على الطلب*\n\n`;
                    message += `*بيانات الطلب:*\n`;
                    message += `- اسم العميل: ${data.customerName}\n`;
                    message += `- المقاس: ${data.size}\n`;
                    message += `- اللون: ${data.color}\n`;
                    message += `- الطباعة: ${data.printType}\n`;
                    message += `- بيد/بدون يد: ${data.handle}\n`;
                    message += `- العدد المطلوب: ${data.quantity}\n`;
                    message += `- شروط الدفع: ${data.paymentTerms}\n`;
                    
                    // Format delivery date
                    const deliveryDate = new Date(data.deliveryDate);
                    const formattedDeliveryDate = `${deliveryDate.getDate()}/${deliveryDate.getMonth() + 1}/${deliveryDate.getFullYear()}`;
                    message += `- تاريخ التسليم: ${formattedDeliveryDate}\n`;
                    
                    // Calculate days remaining
                    const diffTime = deliveryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    message += `- الأيام المتبقية: ${diffDays}\n\n`;
                    
                    message += `*تمت الموافقة بواسطة:*\n`;
                    message += `- الاسم: ${currentUser.displayName || currentUser.email}\n`;
                    message += `- البريد الإلكتروني: ${currentUser.email}\n`;
                    message += `- تاريخ الموافقة: ${formattedToday}\n`;
                }
                else if (type === 'reject_order') {
                    message = `❌ *تم رفض الطلب*\n\n`;
                    message += `*بيانات الطلب:*\n`;
                    message += `- اسم العميل: ${data.customerName}\n`;
                    message += `- المقاس: ${data.size}\n`;
                    message += `- اللون: ${data.color}\n`;
                    message += `- الطباعة: ${data.printType}\n`;
                    message += `- بيد/بدون يد: ${data.handle}\n`;
                    message += `- العدد المطلوب: ${data.quantity}\n`;
                    message += `- شروط الدفع: ${data.paymentTerms}\n`;
                    
                    // Format delivery date
                    const deliveryDate = new Date(data.deliveryDate);
                    const formattedDeliveryDate = `${deliveryDate.getDate()}/${deliveryDate.getMonth() + 1}/${deliveryDate.getFullYear()}`;
                    message += `- تاريخ التسليم: ${formattedDeliveryDate}\n\n`;
                    
                    message += `*سبب الرفض:*\n${data.rejectReason}\n\n`;
                    
                    message += `*تم الرفض بواسطة:*\n`;
                    message += `- الاسم: ${currentUser.displayName || currentUser.email}\n`;
                    message += `- البريد الإلكتروني: ${currentUser.email}\n`;
                    message += `- تاريخ الرفض: ${formattedToday}\n`;
                }
                
                // Send notification to Telegram bot
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                const responseData = await response.json();
                
                if (!responseData.ok) {
                    console.error('Telegram API error:', responseData);
                    throw new Error('Failed to send Telegram notification');
                }
                
                return true;
            } catch (error) {
                console.error('Error sending Telegram notification:', error);
                return false;
            }
        }
        
        // Export to PDF
        function exportToPdf() {
            if (!ordersTable) return;
            
            const pdf = new jsPDF('landscape');
            
            // Get filtered data
            const filteredData = ordersTable.rows({ search: 'applied' }).data().toArray();
            
            // Define columns to export
            const columns = [
                { header: 'اسم العميل', dataKey: 'customerName' },
                { header: 'المقاس', dataKey: 'size' },
                { header: 'اللون', dataKey: 'color' },
                { header: 'الطباعة', dataKey: 'printType' },
                { header: 'بيد/بدون يد', dataKey: 'handle' },
                { header: 'العدد المطلوب', dataKey: 'quantity' },
                { header: 'شروط الدفع', dataKey: 'paymentTerms' },
                { header: 'تاريخ التسليم', dataKey: 'deliveryDate' },
                { header: 'الأيام المتبقية', dataKey: 'daysRemaining' },
                { header: 'حالة الطلب', dataKey: 'status' }
            ];
            
            // Convert status to readable text
            const formattedData = filteredData.map(order => ({
                customerName: order.customerName,
                size: order.size,
                color: order.color,
                printType: order.printType,
                handle: order.handle,
                quantity: order.quantity,
                paymentTerms: order.paymentTerms,
                deliveryDate: order.deliveryDate,
                daysRemaining: order.daysRemaining,
                status: getStatusText(order.status)
            }));
            
            // Add title
            pdf.setFont('Helvetica', 'bold');
            pdf.setFontSize(18);
            pdf.text('طلبات عبوات البلاستيك', pdf.internal.pageSize.width / 2, 20, { align: 'center' });
            
            // Generate table
            pdf.autoTable({
                columns: columns,
                body: formattedData,
                startY: 30,
                styles: {
                    font: 'Helvetica',
                    fontSize: 10
                },
                headStyles: {
                    fillColor: [93, 92, 222],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                },
                margin: { top: 30, right: 10, bottom: 10, left: 10 }
            });
            
            // Save PDF
            pdf.save('طلبات-عبوات-البلاستيك.pdf');
        }
        
        // Export to Excel
        function exportToExcel() {
            if (!ordersTable) return;
            
            // Get filtered data
            const filteredData = ordersTable.rows({ search: 'applied' }).data().toArray();
            
            // Convert data to Excel format
            const excelData = filteredData.map(order => ({
                'اسم العميل': order.customerName,
                'المقاس': order.size,
                'اللون': order.color,
                'الطباعة': order.printType,
                'بيد/بدون يد': order.handle,
                'العدد المطلوب': order.quantity,
                'شروط الدفع': order.paymentTerms,
                'تاريخ التسليم': order.deliveryDate,
                'الأيام المتبقية': order.daysRemaining,
                'حالة الطلب': getStatusText(order.status)
            }));
            
            // Convert to worksheet
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            
            // Create workbook and add worksheet
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'طلبات عبوات البلاستيك');
            
            // Save Excel file
            XLSX.writeFile(workbook, 'طلبات-عبوات-البلاستيك.xlsx');
        }
        
        // Get Status Text
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'معلق';
                case 'accepted': return 'مقبول';
                case 'rejected': return 'مرفوض';
                case 'delivered': return 'تم التسليم';
                case 'overdue': return 'تخطى موعد التسليم';
                default: return 'معلق';
            }
        }
        
        // Get Authentication Error Message
        function getAuthErrorMessage(error) {
            switch(error.code) {
                case 'auth/invalid-email':
                    return 'البريد الإلكتروني غير صحيح';
                case 'auth/user-disabled':
                    return 'تم تعطيل هذا الحساب';
                case 'auth/user-not-found':
                    return 'البريد الإلكتروني غير مسجل';
                case 'auth/wrong-password':
                    return 'كلمة المرور غير صحيحة';
                case 'auth/email-already-in-use':
                    return 'البريد الإلكتروني مستخدم بالفعل';
                case 'auth/weak-password':
                    return 'كلمة المرور ضعيفة جدًا';
                default:
                    return error.message;
            }
        }
        
        // Inactivity Timer Functions
        function resetInactivityTimer() {
            // Reset any existing timer
            clearInactivityTimer();
            
            // Set a new timer
            inactivityTimer = setTimeout(showLogoutWarning, 4 * 60 * 1000); // 4 minutes
            
            // Hide warning if visible
            inactivityWarning.style.display = 'none';
        }
        
        function clearInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
            
            if (logoutCountdown) {
                clearTimeout(logoutCountdown);
                logoutCountdown = null;
            }
            
            if (logoutCountdownInterval) {
                clearInterval(logoutCountdownInterval);
                logoutCountdownInterval = null;
            }
        }
        
        function showLogoutWarning() {
            // Show warning
            inactivityWarning.style.display = 'block';
            
            // Set countdown
            let seconds = 60; // 1 minute countdown
            logoutCountdownEl.textContent = seconds;
            
            // Update countdown every second
            logoutCountdownInterval = setInterval(() => {
                seconds--;
                logoutCountdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(logoutCountdownInterval);
                }
            }, 1000);
            
            // Set logout timer
            logoutCountdown = setTimeout(() => {
                auth.signOut();
                clearInactivityTimer();
                inactivityWarning.style.display = 'none';
            }, 60 * 1000); // 1 minute
        }
        
        // Loading Spinner Functions
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }
    </script>
</body>
</html>
